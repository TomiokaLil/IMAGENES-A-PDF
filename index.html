<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Convertir Im√°genes a PDF</title>
<link rel="icon" type="image/svg+xml" href="favicon.svg">
<style>
:root{--bg1:#fff6fb;--bg2:#f0f7ff;--card:#ffffff;--accent:#7b61ff;--accent2:#ff6fb5;--text:#2b2e37;}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;min-height:100vh;background:linear-gradient(160deg,var(--bg1),var(--bg2));display:flex;align-items:center;justify-content:center;padding:28px;}
.container{width:100%;max-width:820px;background:var(--card);border-radius:18px;padding:26px;box-shadow:0 18px 50px rgba(40,40,60,0.08);position:relative;overflow:hidden;}
.header-dedication{display:flex;align-items:center;gap:12px;justify-content:center;margin-bottom:8px;}
.heart{width:46px;height:46px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--accent),var(--accent2));box-shadow:0 8px 30px rgba(123,97,255,0.18);transform-origin:center;animation:beat 1.1s infinite;}
@keyframes beat{0%{transform:scale(1);}50%{transform:scale(1.08);}100%{transform:scale(1);}}
.dedication-text{font-weight:700;color:var(--accent);font-size:1.05rem;}
.controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center;margin-top:8px;}
input[type=file]{display:none;}
.btn{padding:10px 16px;border-radius:12px;border:0;cursor:pointer;font-weight:700;}
.select-btn{background:linear-gradient(135deg,var(--accent),#4aa3ff);color:white;box-shadow:0 10px 24px rgba(74,163,255,0.12);}
.generate-btn{background:linear-gradient(135deg,var(--accent2),#ff8ab3);color:white;box-shadow:0 10px 24px rgba(255,111,181,0.12);}
.preview{margin-top:18px;display:grid;grid-template-columns:repeat(auto-fill,minmax(72px,1fr));gap:12px;}
.preview img{width:72px;height:72px;object-fit:cover;border-radius:10px;box-shadow:0 6px 18px rgba(20,30,60,0.06);transition:transform .15s;}
.preview img:hover{transform:scale(1.06);}
.footer{margin-top:14px;text-align:center;color:#8b8992;font-size:0.9rem;}
.note{margin-top:8px;color:#8b8992;font-size:0.85rem;text-align:center;}
.notice{background:#fff3f6;border-radius:10px;padding:10px;margin-top:12px;color:#7a3b5f;font-size:0.95rem;display:none;}
@media (max-width:520px){.dedication-text{font-size:0.98rem}.container{padding:18px}}
</style>
</head>
<body>
  <div class="container" role="main">
    <div class="header-dedication" aria-hidden="false">
      <div class="heart" aria-hidden="true">üíñ</div>
      <div class="dedication-text">Hecho con amor para mi amada mujer üíï</div>
    </div>

    <div class="controls" role="toolbar" aria-label="Controles">
      <label class="btn select-btn" for="files">Seleccionar im√°genes</label>
      <input id="files" type="file" accept="image/*" multiple>
      <button id="generate" class="btn generate-btn">Generar PDF</button>
    </div>

    <div id="notice" class="notice"></div>

    <div id="preview" class="preview" aria-live="polite"></div>
    <div class="note">Miniaturas ‚Äî selecciona tantas im√°genes como quieras. Compatible con m√≥viles y escritorio.</div>
  </div>

<script>
// This page tries to use a local jspdf.umd.min.js if present (same folder).
// If not present and the browser is online, it will try to load it from CDN automatically.
// If neither is available, it falls back to the browser print method (works but opens print dialog).

const fileInput = document.getElementById('files');
const preview = document.getElementById('preview');
const generateBtn = document.getElementById('generate');
const notice = document.getElementById('notice');
let files = [];

fileInput.addEventListener('change', (e) => {
  files = Array.from(e.target.files || []);
  renderPreview();
});

function renderPreview(){
  preview.innerHTML = '';
  files.forEach((f, idx) => {
    const reader = new FileReader();
    reader.onload = (ev) => {
      const img = document.createElement('img');
      img.src = ev.target.result;
      img.alt = f.name || ('Imagen ' + (idx + 1));
      preview.appendChild(img);
    };
    reader.readAsDataURL(f);
  });
}

function fileToDataUrl(file){
  return new Promise((resolve) => {
    const r = new FileReader();
    r.onload = e => resolve(e.target.result);
    r.readAsDataURL(file);
  });
}

// Try to load local JS module (jspdf) if available
function loadLocalJs(path){
  return new Promise((resolve, reject) => {
    fetch(path, {method:'HEAD'}).then(h => {
      if (h.ok) {
        const s = document.createElement('script');
        s.src = path;
        s.onload = () => resolve(true);
        s.onerror = () => reject(false);
        document.head.appendChild(s);
      } else reject(false);
    }).catch(()=>reject(false));
  });
}

// Try to load from CDN if online
function loadFromCdn(url){
  return new Promise((resolve, reject) => {
    if (!navigator.onLine) return reject(false);
    const s = document.createElement('script');
    s.src = url;
    s.onload = () => resolve(true);
    s.onerror = () => reject(false);
    document.head.appendChild(s);
  });
}

// Fallback print-based generator (works offline but opens print dialog)
async function generateViaPrint(){
  if (!files.length) { alert('Selecciona al menos una imagen.'); return; }
  const dataUrls = await Promise.all(files.map(f => fileToDataUrl(f)));
  const parts = [];
  parts.push('<!doctype html><html><head><meta charset="utf-8"><title>Im√°genes a PDF</title>');
  parts.push('<style>@page{size:A4;margin:10mm;}body{margin:0;padding:0;} .page{width:210mm;height:297mm;display:flex;justify-content:center;align-items:center;page-break-after:always;} img{max-width:190mm;max-height:277mm;object-fit:contain;}</style>');
  parts.push('</head><body>');
  dataUrls.forEach(src => { parts.push('<div class="page"><img src="'+src+'"></div>'); });
  parts.push('</body></html>');
  const win = window.open('', '_blank');
  if (!win) { alert('El navegador bloque√≥ la ventana emergente. Permite ventanas emergentes y vuelve a intentar.'); return; }
  win.document.open();
  win.document.write(parts.join(''));
  win.document.close();
  // wait images load then call print
  const imgs = win.document.images;
  let loaded = 0;
  if (imgs.length === 0) { win.print(); return; }
  for (let im of imgs){
    im.onload = im.onerror = () => { loaded++; if (loaded === imgs.length) setTimeout(()=>{win.focus();win.print();},250); };
  }
}

// Primary generate function: tries jspdf first, otherwise print fallback
async function generatePdf(){
  if (!files.length) { alert('Selecciona al menos una imagen.'); return; }
  notice.style.display='none';
  // If jsPDF is present, use it
  if (window.jspdf && window.jspdf.jsPDF){
    try {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit:'mm', format:'a4' });
      const pw = pdf.internal.pageSize.getWidth();
      const ph = pdf.internal.pageSize.getHeight();
      for (let i = 0; i < files.length; i++){
        const data = await fileToDataUrl(files[i]);
        const img = new Image();
        img.src = data;
        await new Promise((resolve) => {
          img.onload = () => {
            const aspect = img.width / img.height;
            let w = pw - 20;
            let h = w / aspect;
            if (h > ph - 20){ h = ph - 20; w = h * aspect; }
            const x = (pw - w)/2;
            const y = (ph - h)/2;
            if (i > 0) pdf.addPage();
            pdf.addImage(img, 'JPEG', x, y, w, h);
            resolve();
          };
        });
      }
      pdf.save('imagenes.pdf');
    } catch (err){
      console.error(err);
      notice.textContent = 'Error generando PDF con jsPDF ‚Äî se usar√° la opci√≥n de impresi√≥n.';
      notice.style.display='block';
      generateViaPrint();
    }
    return;
  }

  // Try to load local jspdf.umd.min.js if exists
  try {
    await loadLocalJs('./jspdf.umd.min.js');
    if (window.jspdf && window.jspdf.jsPDF){ generatePdf(); return; }
  } catch(e){ /* no local file */ }

  // Try CDN fallback (works if online)
  try {
    await loadFromCdn('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
    if (window.jspdf && window.jspdf.jsPDF){ generatePdf(); return; }
  } catch(e){ /* can't load */ }

  // Final fallback: print-based method
  notice.textContent = 'jsPDF no est√° disponible localmente. Usando la opci√≥n de impresi√≥n (puedes guardar como PDF desde el di√°logo).';
  notice.style.display='block';
  generateViaPrint();
}

generateBtn.addEventListener('click', generatePdf);
</script>
</body>
</html>
